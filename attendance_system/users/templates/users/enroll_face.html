{% extends "base.html" %}

{% block content %}
<h2>Enroll Face for {{ student.first_name }} {{ student.last_name }}</h2>
<p id="status-message">üì∑ Align your face inside the circle and tap Capture.</p>

<!-- ‚úÖ Video Feed with Face ID Circle -->
<div class="video-container">
    <video id="video" autoplay playsinline></video>
    <div class="face-circle"></div>  <!-- ‚úÖ Circular Face Guide -->
</div>

<!-- ‚úÖ Hidden Canvas for Processing -->
<canvas id="canvas" style="display: none;"></canvas>

<!-- ‚úÖ Buttons -->
<div class="button-container">
    <button id="capture-btn" class="btn btn-primary">üì∏ Capture</button>
    <button id="submit-btn" class="btn btn-success" style="display: none;">‚úÖ Submit</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let captureBtn = document.getElementById("capture-btn");
    let submitBtn = document.getElementById("submit-btn");
    let statusMessage = document.getElementById("status-message");

    // ‚úÖ Select iVCam or Default Webcam
    navigator.mediaDevices.enumerateDevices().then(devices => {
        let cameraId = null;

        devices.forEach(device => {
            if (device.kind === "videoinput") {
                console.log(`Camera Found: ${device.label}`);
                if (device.label.toLowerCase().includes("ivcam")) {
                    cameraId = device.deviceId;
                }
            }
        });

        let constraints = {
            video: cameraId ? { deviceId: { exact: cameraId } } : true
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => { video.srcObject = stream; })
            .catch(error => {
                console.error("‚ö†Ô∏è Camera Access Denied:", error);
                statusMessage.innerText = "‚ö†Ô∏è Webcam access denied!";
            });
    });

    // ‚úÖ Capture Image with Smooth Animation
    captureBtn.addEventListener("click", function () {
        let context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // ‚úÖ Apply Face ID Effect
        video.style.animation = "fadeOut 0.5s forwards";
        statusMessage.innerText = "‚úÖ Face Captured! Click Submit to register.";

        captureBtn.style.display = "none";
        submitBtn.style.display = "inline-block";
    });

    // ‚úÖ Submit Image to Server
    submitBtn.addEventListener("click", function () {
        canvas.toBlob(blob => {
            let formData = new FormData();
            formData.append("face_image", blob);

            fetch("{% url 'enroll_face' student.id %}", {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    statusMessage.innerHTML = "‚úÖ Face registered successfully! <br>Redirecting...";
                    setTimeout(() => { window.location.href = "{% url 'manage_users' %}"; }, 2000);
                } else {
                    statusMessage.innerText = "‚ö†Ô∏è " + data.message;
                    captureBtn.style.display = "inline-block";
                    submitBtn.style.display = "none";
                    video.style.animation = "fadeIn 0.5s forwards"; // Reset animation
                }
            })
            .catch(error => {
                statusMessage.innerText = "‚ö†Ô∏è Error registering face.";
                console.error("Error:", error);
            });
        }, "image/jpeg");
    });
});
</script>

<style>
/* ‚úÖ Full-Screen Camera Like Face ID */
.video-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: auto;
    overflow: hidden;
    border-radius: 50%;
    border: 8px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
}
video {
    width: 100%;
    height: auto;
    display: block;
    filter: brightness(1.2) contrast(1.2); /* ‚úÖ Boost visibility */
}

/* ‚úÖ Circular Face Guide */
.face-circle {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 90%;
    height: 90%;
    transform: translate(-50%, -50%);
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    pointer-events: none;
}

/* ‚úÖ Button Styles */
.button-container {
    display: flex;
    justify-content: center;
    margin-top: 10px;
}
button {
    margin: 5px;
}

/* ‚úÖ Smooth Fade Effect */
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0.2; }
}
@keyframes fadeIn {
    from { opacity: 0.2; }
    to { opacity: 1; }
}
</style>

{% endblock %}
