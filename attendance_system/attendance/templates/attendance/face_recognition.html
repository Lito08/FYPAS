{% extends 'base.html' %}

{% block content %}
<h2>Face Recognition Attendance</h2>
<p>Scan your face to mark attendance.</p>

<!-- ✅ Video Stream for Face Capture -->
<video id="video" width="640" height="480" autoplay></video>
<button id="capture-btn" class="btn btn-primary">Capture & Submit</button>

<!-- ✅ Canvas (Hidden) for Image Capture -->
<canvas id="canvas" width="640" height="480" style="display: none;"></canvas>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("capture-btn");

    // ✅ Request camera access
    navigator.mediaDevices.enumerateDevices().then(devices => {
        let cameraId = null;

        devices.forEach(device => {
            if (device.kind === "videoinput") {
                console.log(`Camera Found: ${device.label}`);
                if (device.label.toLowerCase().includes("ivcam")) {
                    cameraId = device.deviceId;
                }
            }
        });

        let constraints = {
            video: cameraId ? { deviceId: { exact: cameraId } } : true
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => { video.srcObject = stream; })
            .catch(error => {
                console.error("⚠️ Camera Access Denied:", error);
                statusMessage.innerText = "⚠️ Webcam access denied!";
            });
    });

    captureBtn.addEventListener("click", function () {
        // ✅ Capture image from video
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // ✅ Convert image to Blob
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append("face_image", blob);

            // ✅ Send image to the backend for recognition
            fetch("{{ request.path }}", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === "success") {
                    window.location.href = "/attendance/records/"; // Redirect if successful
                }
            })
            .catch(error => console.error("Error submitting face:", error));
        }, "image/jpeg");
    });
});
</script>

{% endblock %}
